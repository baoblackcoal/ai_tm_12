<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>示波器智能交互系统 - 高校实验场景</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        .scope-interface {
            position: relative;
            margin: 40px auto;
            width: 1000px;
            height: 680px;
            background-color: #111;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }
        .scope-header {
            background-color: #222;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .scope-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-dot.connected {
            background-color: #4ade80;
        }
        .status-dot.disconnected {
            background-color: #ef4444;
        }
        .status-dot.running {
            background-color: #3b82f6;
        }
        .status-dot.stopped {
            background-color: #f97316;
        }
        .main-content {
            display: flex;
            flex: 1;
            height: calc(100% - 50px); /* 减去头部状态栏的高度 */
            overflow: hidden;
        }
        .scope-display {
            flex: 2;
            background-color: #000;
            position: relative;
            overflow: hidden;
            border-right: 1px solid #333;
        }
        .scope-screen {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-height: 100%;
            display: block;
        }
        .chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            height: 100%;
            overflow: hidden;
        }
        .chat-messages {
            flex: 1;
            overflow-y: scroll;
            padding: 15px;
            height: calc(100% - 70px); /* 减去输入区域的高度 */
            scrollbar-width: thin;
            scrollbar-color: #444 #222;
        }
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #222;
            border-radius: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
            border: 2px solid #222;
        }
        .message {
            margin-bottom: 15px;
            max-width: 90%;
        }
        .message-content {
            padding: 10px 12px;
            border-radius: 8px;
            overflow-wrap: break-word;
        }
        .user-message {
            margin-left: auto;
        }
        .user-message .message-content {
            background-color: #0b84ff;
            color: white;
            border-bottom-right-radius: 2px;
        }
        .ai-message {
            margin-right: auto;
        }
        .ai-message .message-content {
            background-color: #2c2c2e;
            color: white;
            border-bottom-left-radius: 2px;
        }
        .command-preview {
            background-color: #1e293b;
            color: #94a3b8;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 3px solid #3b82f6;
        }
        .confirmation-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .confirm-button {
            background-color: #4ade80;
            color: #0f172a;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .modify-button {
            background-color: #f59e0b;
            color: #0f172a;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .cancel-button {
            background-color: #ef4444;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .execution-status {
            background-color: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            font-size: 14px;
        }
        .status-step {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .status-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-text {
            flex: 1;
        }
        .complete-step {
            color: #4ade80;
        }
        .active-step {
            color: #3b82f6;
        }
        .pending-step {
            color: #94a3b8;
        }
        .error-step {
            color: #ef4444;
        }
        .measurement-result {
            background-color: #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            border-left: 3px solid #8b5cf6;
        }
        .result-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #a78bfa;
        }
        .result-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .result-unit {
            color: #94a3b8;
            font-size: 14px;
        }
        .result-image {
            width: 100%;
            border-radius: 4px;
            margin-top: 8px;
        }
        .code-block {
            background-color: #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 3px solid #8b5cf6;
            font-size: 13px;
            overflow-x: auto;
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #a78bfa;
            font-weight: bold;
        }
        .copy-button {
            background-color: #2d3748;
            color: #cbd5e0;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .copy-button:hover {
            background-color: #4a5568;
        }
        .chat-input {
            flex-shrink: 0;
            height: 70px;
            display: flex;
            padding: 15px;
            background-color: #1c1c1e;
            border-top: 1px solid #333;
        }
        .input-field {
            flex: 1;
            padding: 10px 15px;
            background-color: #2c2c2e;
            border: none;
            border-radius: 20px;
            color: white;
            outline: none;
        }
        .input-button {
            width: 40px;
            height: 40px;
            background-color: #0b84ff;
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            cursor: pointer;
        }
        .input-button.mic {
            background-color: #4ade80;
        }
        .instrument-dashboard {
            background-color: #1c1c1e;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        .instrument-card {
            background-color: #2c2c2e;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
        }
        .instrument-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .instrument-name {
            font-weight: bold;
            color: #a78bfa;
        }
        .instrument-status {
            font-size: 12px;
            color: #94a3b8;
        }
        .instrument-params {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            font-size: 12px;
        }
        .param-label {
            color: #94a3b8;
        }
        .param-value {
            color: white;
        }
        .safety-warning {
            background-color: #ef4444;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
        }
        .data-table th,
        .data-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #2c2c2e;
        }
        .chart-container {
            width: 100%;
            height: 200px;
            background-color: #1c1c1e;
            border-radius: 8px;
            margin: 8px 0;
            position: relative;
        }
        .chart-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #94a3b8;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex items-center mb-8">
            <a href="../index.html" class="text-green-500 hover:text-green-400">
                <i class="fas fa-arrow-left mr-2"></i>返回
            </a>
            <h1 class="text-2xl font-bold text-green-500 ml-4">阶段 2: 指令集 AI Agent 控制系统 - 高校实验场景</h1>
        </div>
        
        <div class="text-center mb-8">
            <p class="text-gray-400 max-w-2xl mx-auto">将自然语言指令转化为 SCPI 命令，控制示波器、信号发生器、电源等仪器完成实验任务。</p>
        </div>

        <!-- 示波器界面模拟 -->
        <div class="scope-interface">
            <!-- 头部状态栏 -->
            <div class="scope-header">
                <div class="text-lg font-bold">示波器智能控制系统</div>
                <div class="scope-status">
                    <div class="status-indicator">
                        <div class="status-dot connected"></div>
                        <span>已连接</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot running"></div>
                        <span>运行中</span>
                    </div>
                    <div class="status-indicator">
                        <div class="text-sm">IP: 192.168.1.105</div>
                    </div>
                </div>
            </div>

            <!-- 主体内容区 -->
            <div class="main-content">
                <!-- 示波器显示区 -->
                <div class="scope-display">
                    <img src="https://www.owon.com.hk/Upload/PicFiles/2025441345476589.png" alt="示波器屏幕" class="scope-screen">
                </div>

                <!-- 对话交互区 -->
                <div class="chat-interface">
                    <div class="chat-messages">
                        <!-- AI 欢迎消息 -->
                        <div class="message ai-message">
                            <div class="message-content">
                                欢迎使用示波器指令控制系统！我可以帮您控制实验室仪器完成实验任务。当前已连接：
                                <div class="instrument-dashboard">
                                    <div class="instrument-card">
                                        <div class="instrument-header">
                                            <div class="instrument-name">示波器 (FDS4112)</div>
                                            <div class="instrument-status">已连接</div>
                                        </div>
                                        <div class="instrument-params">
                                            <div class="param-label">时基</div>
                                            <div class="param-value">1ms/div</div>
                                            <div class="param-label">通道 1</div>
                                            <div class="param-value">1V/div</div>
                                            <div class="param-label">通道 2</div>
                                            <div class="param-value">1V/div</div>
                                        </div>
                                    </div>
                                    <div class="instrument-card">
                                        <div class="instrument-header">
                                            <div class="instrument-name">信号发生器 (FDS4112)</div>
                                            <div class="instrument-status">已连接</div>
                                        </div>
                                        <div class="instrument-params">
                                            <div class="param-label">波形</div>
                                            <div class="param-value">正弦波</div>
                                            <div class="param-label">频率</div>
                                            <div class="param-value">1kHz</div>
                                            <div class="param-label">幅度</div>
                                            <div class="param-value">1Vpp</div>
                                        </div>
                                    </div>
                                    <div class="instrument-card">
                                        <div class="instrument-header">
                                            <div class="instrument-name">电源 (FDS4112)</div>
                                            <div class="instrument-status">已连接</div>
                                        </div>
                                        <div class="instrument-params">
                                            <div class="param-label">通道 1</div>
                                            <div class="param-value">+12V</div>
                                            <div class="param-label">通道 2</div>
                                            <div class="param-value">-12V</div>
                                        </div>
                                    </div>
                                </div>
                                请问需要进行什么实验测量？
                            </div>
                        </div>

                        <!-- 用户指令 -->
                        <div class="message user-message">
                            <div class="message-content">
                                测量运放电路的开环增益特性，需要从 100Hz 到 1MHz 扫频，每个频率点记录输入输出电压
                            </div>
                        </div>

                        <!-- AI 操作计划 -->
                        <div class="message ai-message">
                            <div class="message-content">
                                <div class="safety-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>注意：测量开环增益时需要注意以下事项：
                                        1. 输入信号幅度不要太大，避免饱和
                                        2. 确保运放供电电压正确
                                        3. 注意共地连接</span>
                                </div>
                                
                                我将帮您完成开环增益测量，具体步骤如下：

                                <div class="mt-4 bg-gray-800 rounded-lg p-4">
                                    <div class="font-bold mb-2">实验步骤：</div>
                                    <ol class="list-decimal pl-4 space-y-2">
                                        <li>设置运放供电电压：±12V</li>
                                        <li>配置示波器：
                                            <ul class="list-disc pl-4 mt-1">
                                                <li>CH1: 输入信号 (10mV/div)</li>
                                                <li>CH2: 输出信号 (2V/div)</li>
                                                <li>时基：根据频率自动调整</li>
                                            </ul>
                                        </li>
                                        <li>配置信号发生器：
                                            <ul class="list-disc pl-4 mt-1">
                                                <li>正弦波，10mVpp</li>
                                                <li>从 100Hz 开始扫频</li>
                                            </ul>
                                        </li>
                                    </ol>
                                </div>

                                <div class="mt-4">
                                    这是我计划执行的命令序列：
                                    <div class="command-preview">
    // 1. 设置电源
    :FDS4112:PS:CH1 12V
    :FDS4112:PS:CH2 -12V
    :FDS4112:PS:OUTPUT ON

    // 2. 配置示波器
    :FDS4112:CH1:SCALE 10mV
    :FDS4112:CH2:SCALE 2V
    :FDS4112:TIMEBASE:MODE AUTO
    :FDS4112:TRIGGER:MODE AUTO

    // 3. 配置信号发生器
    :FDS4112:WAVE:SHAPE SIN
    :FDS4112:WAVE:AMPL 10mV
    :FDS4112:WAVE:OFFSET 0V
    :FDS4112:OUTPUT ON

    // 4. 开始扫频测量
    for freq in [100, 200, 500, 1k, 2k, 5k, 10k, 20k, 50k, 100k, 200k, 500k, 1M]:
        :FDS4112:WAVE:FREQ {freq}
        :FDS4112:MEASURE:VPP? CH1
        :FDS4112:MEASURE:VPP? CH2
        :FDS4112:MEASURE:PHASE? CH1,CH2</div>
                                </div>

                                <div class="confirmation-buttons">
                                    <div class="confirm-button">开始测量</div>
                                    <div class="modify-button">调整参数</div>
                                    <div class="cancel-button">取消</div>
                                </div>
                            </div>
                        </div>

                        <!-- AI 执行状态 - 代码执行 -->
                        <div class="message ai-message">
                            <div class="message-content">
                                <div class="execution-status">
                                    <div class="status-step complete-step">
                                        <div class="status-icon"><i class="fas fa-check-circle"></i></div>
                                        <div class="status-text">正在连接仪器...</div>
                                    </div>
                                    <div class="status-step complete-step">
                                        <div class="status-icon"><i class="fas fa-check-circle"></i></div>
                                        <div class="status-text">示波器和信号发生器连接成功</div>
                                    </div>
                                    <div class="status-step error-step">
                                        <div class="status-icon"><i class="fas fa-times-circle"></i></div>
                                        <div class="status-text">测量过程出错</div>
                                    </div>
                                </div>

                                <div class="mt-4 bg-red-900 text-red-100 rounded-lg p-4">
                                    <div class="font-bold">错误信息：</div>
                                    <div class="font-mono mt-1">
                                        Traceback (most recent call last):<br>
                                        File "transistor_freq_response.py", line 138, in &lt;module&gt;<br>
                                            &nbsp;&nbsp;main()<br>
                                        File "transistor_freq_response.py", line 122, in main<br>
                                            &nbsp;&nbsp;results = frequency_sweep(scope, gen, frequencies)<br>
                                        File "transistor_freq_response.py", line 78, in frequency_sweep<br>
                                            &nbsp;&nbsp;input_vpp = float(scope.query("MEAS:VPP?").strip())<br>
                                        pyvisa.errors.VisaIOError: VI_ERROR_TMO (-1073807339): Timeout expired before operation completed.
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <div class="font-bold">诊断：</div>
                                    <p>执行过程中遇到超时错误。这可能是因为：</p>
                                    <ol class="list-decimal pl-6 mt-2">
                                        <li>示波器测量命令格式不正确</li>
                                        <li>没有足够的等待时间让示波器完成测量</li>
                                        <li>示波器可能需要先完成自动量程调整</li>
                                    </ol>
                                    
                                    <p class="mt-2">我将修改代码以解决这些问题：</p>
                                </div>
                            </div>
                        </div>

                        <!-- AI 修复代码 -->
                        <div class="message ai-message">
                            <div class="message-content">
                                <div class="font-bold">修复代码：</div>
                                <div class="code-block">
                                    <div class="code-block-header">
                                        <div>修复的 frequency_sweep 函数</div>
                                        <div class="copy-button">复制</div>
                                    </div>
```python
# 进行频率扫描测量（修复版）
def frequency_sweep(scope, gen, frequencies):
    results = []
    
    # 增加超时时间
    original_timeout = scope.timeout
    scope.timeout = 10000  # 增加到10秒
    
    for freq in frequencies:
        print(f"测量频率: {freq} Hz")
        
        # 设置信号发生器频率
        gen.write(f"FREQ {freq}")
        gen.write("OUTPUT ON")
        
        # 根据频率调整示波器时基
        if freq < 1000:
            timebase = 0.5/freq
        elif freq < 10000:
            timebase = 0.0001
        elif freq < 100000:
            timebase = 0.00001
        else:
            timebase = 0.000001
            
        scope.write(f"TIM:SCALE {timebase}")
        
        # 等待更长时间以稳定波形
        time.sleep(1.5)
        
        # 使用适当的命令格式并添加错误处理
        try:
            # 自动调整垂直刻度以获得更好的测量结果
            scope.write("CHAN1:SCALE:AUTO")
            scope.write("CHAN2:SCALE:AUTO")
            time.sleep(1)
            
            # 确保停止连续获取以进行稳定测量
            scope.write("STOP")
            time.sleep(0.5)
            
            # 测量输入信号(通道1)幅度
            scope.write("MEAS:SOUR CHAN1")
            scope.write("MEAS:VPP")
            input_vpp_str = scope.query("MEAS:RES?").strip()
            input_vpp = float(input_vpp_str)
            
            # 测量输出信号(通道2)幅度
            scope.write("MEAS:SOUR CHAN2")
            scope.write("MEAS:VPP")
            output_vpp_str = scope.query("MEAS:RES?").strip()
            output_vpp = float(output_vpp_str)
            
            # 测量相位差 - 使用更可靠的方法
            scope.write("MEAS:SOUR CHAN1,CHAN2")
            scope.write("MEAS:PHAS")
            phase_str = scope.query("MEAS:RES?").strip()
            
            # 处理可能的错误返回值
            try:
                phase = float(phase_str)
            except ValueError:
                print(f"  相位测量无效: {phase_str}, 使用默认值")
                phase = 0.0
            
            # 重新启动连续获取
            scope.write("RUN")
            
            # 计算增益(dB)
            if input_vpp > 0 and output_vpp > 0:
                gain_db = 20 * np.log10(output_vpp / input_vpp)
            else:
                print("  警告: 测量到的幅度为零，使用默认增益")
                gain_db = 0
            
            # 存储结果
            results.append({
                'frequency': freq,
                'input_vpp': input_vpp,
                'output_vpp': output_vpp,
                'gain_db': gain_db,
                'phase': phase
            })
            
            print(f"  输入: {input_vpp:.3f}Vpp, 输出: {output_vpp:.3f}Vpp")
            print(f"  增益: {gain_db:.2f}dB, 相位: {phase:.2f}°")
            
        except Exception as e:
            print(f"  测量频率 {freq}Hz 出错: {e}")
            # 添加错误结果但标记为无效
            results.append({
                'frequency': freq,
                'input_vpp': 0,
                'output_vpp': 0,
                'gain_db': 0,
                'phase': 0,
                'error': str(e)
            })
            
            # 尝试恢复示波器状态
            try:
                scope.write("*CLS")  # 清除状态
                scope.write("RUN")   # 重新运行
            except:
                pass
    
    # 恢复原始超时
    scope.timeout = original_timeout
    
    # 关闭信号发生器输出
    gen.write("OUTPUT OFF")
    return results
```
                                </div>

                                <div class="mt-4">
                                    <div class="font-bold">主要修复：</div>
                                    <ol class="list-decimal pl-6 space-y-1">
                                        <li>增加了示波器超时时间</li>
                                        <li>修正了SCPI测量命令格式</li>
                                        <li>添加了自动垂直刻度调整</li>
                                        <li>引入暂停/运行获取模式来提高测量稳定性</li>
                                        <li>增强了错误处理</li>
                                        <li>添加了恢复机制，防止一个频点失败影响整个测量</li>
                                    </ol>

                                    <div class="confirmation-buttons mt-4">
                                        <div class="confirm-button">重新执行</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI 执行状态 -->
                        <div class="message ai-message">
                            <div class="message-content">
                                <div class="execution-status">
                                    <div class="status-step complete-step">
                                        <div class="status-icon"><i class="fas fa-check-circle"></i></div>
                                        <div class="status-text">电源设置完成</div>
                                    </div>
                                    <div class="status-step complete-step">
                                        <div class="status-icon"><i class="fas fa-check-circle"></i></div>
                                        <div class="status-text">示波器配置完成</div>
                                    </div>
                                    <div class="status-step active-step">
                                        <div class="status-icon"><i class="fas fa-spinner fa-spin"></i></div>
                                        <div class="status-text">正在进行频率扫描 (7/13)</div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <div class="font-bold">实时测量数据：</div>
                                    <div class="data-table">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>频率</th>
                                                    <th>输入 (mVpp)</th>
                                                    <th>输出 (Vpp)</th>
                                                    <th>增益 (dB)</th>
                                                    <th>相位差 (°)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>100 Hz</td>
                                                    <td>10.2</td>
                                                    <td>8.45</td>
                                                    <td>58.3</td>
                                                    <td>-2.1</td>
                                                </tr>
                                                <tr>
                                                    <td>200 Hz</td>
                                                    <td>10.1</td>
                                                    <td>8.42</td>
                                                    <td>58.4</td>
                                                    <td>-4.3</td>
                                                </tr>
                                                <tr>
                                                    <td>500 Hz</td>
                                                    <td>10.1</td>
                                                    <td>8.38</td>
                                                    <td>58.3</td>
                                                    <td>-10.5</td>
                                                </tr>
                                                <tr>
                                                    <td>1 kHz</td>
                                                    <td>10.0</td>
                                                    <td>8.21</td>
                                                    <td>58.2</td>
                                                    <td>-21.2</td>
                                                </tr>
                                                <tr>
                                                    <td>2 kHz</td>
                                                    <td>10.1</td>
                                                    <td>7.85</td>
                                                    <td>57.8</td>
                                                    <td>-42.5</td>
                                                </tr>
                                                <tr>
                                                    <td>5 kHz</td>
                                                    <td>10.0</td>
                                                    <td>6.92</td>
                                                    <td>56.8</td>
                                                    <td>-89.3</td>
                                                </tr>
                                                <tr>
                                                    <td>10 kHz</td>
                                                    <td>10.1</td>
                                                    <td>5.23</td>
                                                    <td>54.3</td>
                                                    <td>-135.2</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <div class="chart-container">
                                        <div class="chart-placeholder">
                                            <i class="fas fa-chart-line text-4xl mb-2"></i>
                                            <div>增益-频率特性曲线</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <div class="bg-blue-900 text-blue-100 rounded-lg p-4">
                                        <div class="font-bold mb-2">实时分析：</div>
                                        <ul class="list-disc pl-4">
                                            <li>当前测得开环增益约为 58dB</li>
                                            <li>-3dB 频率点预计在 15kHz 左右</li>
                                            <li>相位裕度约为 45°</li>
                                            <li>建议在 10kHz 以下使用，以确保稳定性</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 新增用户请求 - 晶体管测量 -->
                        <div class="message user-message">
                            <div class="message-content">
                                我需要测量晶体管共射极放大器的幅频特性曲线，请用Python写一个SCPI程序自动完成测量
                            </div>
                        </div>

                        <!-- AI 回复 - 编码方案 -->
                        <div class="message ai-message">
                            <div class="message-content">
                                <div class="safety-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>注意：测量前请确保共射极放大器电路已正确搭建，电源已接通且电压稳定。测量过程中不要触碰电路。</span>
                                </div>

                                <div class="mt-3">我将帮您编写一个Python程序来自动测量晶体管共射极放大器的幅频特性。</div>

                                <div class="mt-3 bg-gray-800 rounded-lg p-4">
                                    <div class="font-bold mb-2">实验方案：</div>
                                    <ol class="list-decimal pl-4 space-y-2">
                                        <li>使用Python与PyVISA库通过SCPI命令控制仪器</li>
                                        <li>配置信号发生器输出不同频率的正弦波信号</li>
                                        <li>配置示波器测量输入/输出信号</li>
                                        <li>记录各频率点的增益和相位数据</li>
                                        <li>使用Matplotlib绘制幅频特性曲线</li>
                                        <li>生成测量报告</li>
                                    </ol>
                                </div>

                                <div class="mt-4">
                                    <div class="font-bold">Python SCPI代码：</div>
                                    <div class="code-block">
                                        <div class="code-block-header">
                                            <div>transistor_freq_response.py</div>
                                            <div class="copy-button">复制</div>
                                        </div>
```python
import pyvisa
import time
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime

# 连接到仪器
def connect_instruments():
    rm = pyvisa.ResourceManager()
    try:
        # 查找可用资源
        resources = rm.list_resources()
        print(f"可用资源: {resources}")
        
        # 连接示波器
        scope = rm.open_resource('TCPIP0::192.168.1.105::inst0::INSTR')
        # 连接信号发生器
        gen = rm.open_resource('TCPIP0::192.168.1.106::inst0::INSTR')
        
        # 验证连接
        print(f"示波器: {scope.query('*IDN?')}")
        print(f"信号发生器: {gen.query('*IDN?')}")
        
        return scope, gen
    except Exception as e:
        print(f"连接失败: {e}")
        return None, None

# 配置仪器
def setup_instruments(scope, gen):
    # 重置仪器
    scope.write("*RST")
    gen.write("*RST")
    time.sleep(1)
    
    # 配置信号发生器
    gen.write("OUTPUT:LOAD 50")     # 设置输出负载为50Ω
    gen.write("VOLT:UNIT VPP")      # 设置电压单位为Vpp
    gen.write("FUNC SIN")           # 设置为正弦波
    gen.write("VOLT 0.1")           # 设置幅度为100mV
    gen.write("VOLT:OFFS 0")        # 设置偏置为0V
    
    # 配置示波器
    scope.write("CHAN1:DISP ON")    # 开启通道1（输入信号）
    scope.write("CHAN2:DISP ON")    # 开启通道2（输出信号）
    scope.write("CHAN1:COUP DC")    # 通道1为DC耦合
    scope.write("CHAN2:COUP DC")    # 通道2为DC耦合
    scope.write("CHAN1:SCALE 0.05") # 通道1垂直刻度50mV/div
    scope.write("CHAN2:SCALE 0.5")  # 通道2垂直刻度500mV/div
    scope.write("TIM:SCALE 0.0001") # 初始时基设置为100μs/div
    scope.write("TRIG:MODE AUTO")   # 自动触发
    
    print("仪器配置完成")

# 进行频率扫描测量
def frequency_sweep(scope, gen, frequencies):
    results = []
    
    # 增加超时时间
    original_timeout = scope.timeout
    scope.timeout = 10000  # 增加到10秒
    
    for freq in frequencies:
        print(f"测量频率: {freq} Hz")
        
        # 设置信号发生器频率
        gen.write(f"FREQ {freq}")
        gen.write("OUTPUT ON")
        
        # 根据频率调整示波器时基
        if freq < 1000:
            timebase = 0.5/freq
        elif freq < 10000:
            timebase = 0.0001
        elif freq < 100000:
            timebase = 0.00001
        else:
            timebase = 0.000001
            
        scope.write(f"TIM:SCALE {timebase}")
        
        # 等待更长时间以稳定波形
        time.sleep(1.5)
        
        # 使用适当的命令格式并添加错误处理
        try:
            # 自动调整垂直刻度以获得更好的测量结果
            scope.write("CHAN1:SCALE:AUTO")
            scope.write("CHAN2:SCALE:AUTO")
            time.sleep(1)
            
            # 确保停止连续获取以进行稳定测量
            scope.write("STOP")
            time.sleep(0.5)
            
            # 测量输入信号(通道1)幅度
            scope.write("MEAS:SOUR CHAN1")
            scope.write("MEAS:VPP")
            input_vpp_str = scope.query("MEAS:RES?").strip()
            input_vpp = float(input_vpp_str)
            
            # 测量输出信号(通道2)幅度
            scope.write("MEAS:SOUR CHAN2")
            scope.write("MEAS:VPP")
            output_vpp_str = scope.query("MEAS:RES?").strip()
            output_vpp = float(output_vpp_str)
            
            # 测量相位差 - 使用更可靠的方法
            scope.write("MEAS:SOUR CHAN1,CHAN2")
            scope.write("MEAS:PHAS")
            phase_str = scope.query("MEAS:RES?").strip()
            
            # 处理可能的错误返回值
            try:
                phase = float(phase_str)
            except ValueError:
                print(f"  相位测量无效: {phase_str}, 使用默认值")
                phase = 0.0
            
            # 重新启动连续获取
            scope.write("RUN")
            
            # 计算增益(dB)
            if input_vpp > 0 and output_vpp > 0:
                gain_db = 20 * np.log10(output_vpp / input_vpp)
            else:
                print("  警告: 测量到的幅度为零，使用默认增益")
                gain_db = 0
            
            # 存储结果
            results.append({
                'frequency': freq,
                'input_vpp': input_vpp,
                'output_vpp': output_vpp,
                'gain_db': gain_db,
                'phase': phase
            })
            
            print(f"  输入: {input_vpp:.3f}Vpp, 输出: {output_vpp:.3f}Vpp")
            print(f"  增益: {gain_db:.2f}dB, 相位: {phase:.2f}°")
            
        except Exception as e:
            print(f"  测量频率 {freq}Hz 出错: {e}")
            # 添加错误结果但标记为无效
            results.append({
                'frequency': freq,
                'input_vpp': 0,
                'output_vpp': 0,
                'gain_db': 0,
                'phase': 0,
                'error': str(e)
            })
            
            # 尝试恢复示波器状态
            try:
                scope.write("*CLS")  # 清除状态
                scope.write("RUN")   # 重新运行
            except:
                pass
    
    # 恢复原始超时
    scope.timeout = original_timeout
    
    # 关闭信号发生器输出
    gen.write("OUTPUT OFF")
    return results

# 绘制幅频曲线
def plot_frequency_response(results):
    frequencies = [r['frequency'] for r in results]
    gain_db = [r['gain_db'] for r in results]
    phase = [r['phase'] for r in results]
    
    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8))
    
    # 幅度响应曲线
    ax1.semilogx(frequencies, gain_db, 'b-', marker='o')
    ax1.set_xlabel('频率 (Hz)')
    ax1.set_ylabel('增益 (dB)')
    ax1.set_title('晶体管共射极放大器幅度响应')
    ax1.grid(True)
    
    # 找出-3dB点
    max_gain = max(gain_db)
    cutoff_gain = max_gain - 3
    cutoff_freq = None
    
    for i in range(len(frequencies)-1):
        if gain_db[i] >= cutoff_gain and gain_db[i+1] < cutoff_gain:
            # 线性插值计算截止频率
            f1, f2 = frequencies[i], frequencies[i+1]
            g1, g2 = gain_db[i], gain_db[i+1]
            cutoff_freq = f1 + (f2 - f1) * (cutoff_gain - g1) / (g2 - g1)
            break
    
    if cutoff_freq:
        ax1.axhline(y=cutoff_gain, color='r', linestyle='--', alpha=0.5)
        ax1.axvline(x=cutoff_freq, color='r', linestyle='--', alpha=0.5)
        ax1.annotate(f'截止频率: {cutoff_freq:.2f}Hz',
                    xy=(cutoff_freq, cutoff_gain),
                    xytext=(cutoff_freq*1.5, cutoff_gain-5),
                    arrowprops=dict(facecolor='red', shrink=0.05))
    
    # 相位响应曲线
    ax2.semilogx(frequencies, phase, 'g-', marker='o')
    ax2.set_xlabel('频率 (Hz)')
    ax2.set_ylabel('相位 (度)')
    ax2.set_title('晶体管共射极放大器相位响应')
    ax2.grid(True)
    
    plt.tight_layout()
    plt.savefig('transistor_frequency_response.png', dpi=300)
    plt.show()
    
    return cutoff_freq

# 生成测试报告
def generate_report(results, cutoff_freq):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    max_gain = max(r['gain_db'] for r in results)
    
    report = f"""
    ===== 晶体管共射极放大器幅频特性测试报告 =====
    测试时间: {timestamp}
    
    测试结果:
    * 最大增益: {max_gain:.2f} dB
    * 截止频率(-3dB): {cutoff_freq:.2f} Hz
    
    频率响应数据:
    频率(Hz)    输入(Vpp)    输出(Vpp)    增益(dB)    相位(°)
    """
    
    for r in results:
        report += f"\n    {r['frequency']:<10} {r['input_vpp']:<12.3f} {r['output_vpp']:<12.3f} {r['gain_db']:<10.2f} {r['phase']:<10.2f}"
    
    report += """
    
    测试结论:
    该晶体管共射极放大器放大性能良好，可应用于音频信号放大。
    由于高频截止特性，不适合用于射频信号放大。
    
    ========================================
    """
    
    with open('transistor_test_report.txt', 'w') as f:
        f.write(report)
    
    print("测试报告已生成: transistor_test_report.txt")
    return report

# 主函数
def main():
    print("开始共射极放大器幅频特性测量...")
    
    # 连接仪器
    scope, gen = connect_instruments()
    if not scope or not gen:
        print("无法连接仪器，测量中止")
        return
    
    # 配置仪器
    setup_instruments(scope, gen)
    
    # 设置测量频率点（对数间隔）
    frequencies = [
        100, 200, 500, 
        1000, 2000, 5000, 
        10000, 20000, 50000, 
        100000, 200000, 500000, 
        1000000
    ]
    
    # 进行扫频测量
    results = frequency_sweep(scope, gen, frequencies)
    
    # 绘制幅频特性曲线
    cutoff_freq = plot_frequency_response(results)
    
    # 生成测试报告
    report = generate_report(results, cutoff_freq)
    print(report)
    
    # 关闭仪器连接
    scope.close()
    gen.close()
    
    print("测量完成")

if __name__ == "__main__":
    main()
```
                            </div>
                        </div>

                        <div class="mt-4">
                            <div class="confirmation-buttons">
                                <div class="confirm-button">执行程序</div>
                                <div class="modify-button">修改代码</div>
                                <div class="cancel-button">取消</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="chat-input">
                <input type="text" class="input-field" placeholder="输入指令或问题...">
                <button class="input-button mic">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="input-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 简单交互演示
        document.addEventListener('DOMContentLoaded', function() {
            const confirmButton = document.querySelector('.confirm-button');
            const statusMessage = document.querySelector('.execution-status');
            const resultMessage = document.querySelector('.message-content .data-table').parentNode.parentNode;
            const chatMessages = document.querySelector('.chat-messages');
            
            // 初始隐藏状态消息和结果
            statusMessage.parentNode.parentNode.style.display = 'none';
            resultMessage.style.display = 'none';
            
            // 确保聊天窗口初始滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            confirmButton.addEventListener('click', function() {
                // 显示状态消息
                statusMessage.parentNode.parentNode.style.display = 'block';
                
                // 滚动到可见
                setTimeout(function() {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
                
                // 3秒后显示结果
                setTimeout(function() {
                    resultMessage.style.display = 'block';
                    // 确保结果可见
                    setTimeout(function() {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }, 3000);
            });
            
            // 确保图片加载完成后布局正确
            const scopeImage = document.querySelector('.scope-screen');
            scopeImage.onload = function() {
                // 确保图片适配容器
                const display = scopeImage.parentElement;
                if (scopeImage.naturalHeight / scopeImage.naturalWidth > display.clientHeight / display.clientWidth) {
                    scopeImage.style.height = '100%';
                    scopeImage.style.width = 'auto';
                }
            };
        });
    </script>
</body>
</html> 